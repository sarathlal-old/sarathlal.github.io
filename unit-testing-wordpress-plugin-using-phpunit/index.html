<!doctype html> <html lang="en"> <head> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <link rel="canonical" href="https://sarathlal.com/unit-testing-wordpress-plugin-using-phpunit/"> <title>Unit testing WordPress plugin using PHPUnit - Sarathlal N</title> <meta name="description" content="Prerequisite Here is my system stack &amp; supporting tools with version number. LAMP stack (Linux Mint 20.2, Apache 2.4.41, MySql 15.1, PHP 7.4.3) Wo..."> <link rel="icon" href="https://sarathlal.com/favicon.ico" sizes="32x32" /> <link rel="icon" href="https://sarathlal.com/siteicon.png" sizes="152x152" /> <link rel="apple-touch-icon-precomposed" href="https://sarathlal.com/siteicon.png" /> <meta name="msapplication-TileImage" content="https://sarathlal.com/siteicon.png" /> <style> /* Normalize start */ html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none} /* Normalize end */ /* Custom start */ p{font-size:1.25rem;line-height:1.8} body {font-family: -apple-system, system-ui, BlinkMacSystemFont, Roboto, Oxygen, Oxygen-Sans, Ubuntu, Cantarell, "Segoe UI", "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif; color: #3a3a3a;} .container {max-width: 42rem;margin: 0 auto;font-size: 1.25rem; padding:0 1rem;} h1, h2, h3, h4, h5, h6 {color: #4e4e4e; line-height:1.4} pre {font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 1.25rem;} code, kbd, samp {font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 1.15rem;} p code, li code, table code {background-color: #f5f5f5;padding: 0.15rem 0.35rem;border: 1px solid #e2e2e2;border-radius: 2px;color: #c10000} img {max-width: 100%;} .clearfix:after {content: "";display: table;clear: both;} header{margin: 3rem 0 4rem; } header a {text-decoration:none; color: #4e4e4e;} header a:hover {border-bottom: 1px solid #4e4e4e;} header h2 a:hover{border-bottom:none} header h2 {font-size: 1.5rem;letter-spacing: 0.02em; margin-bottom: 0.5rem;} header nav {text-align:left;font-size: 1.1rem;} header nav ul {list-style-type: none;margin: 0;padding: 0;overflow: hidden;} header nav ul li {float: left;line-height: inherit;} header nav ul li a {margin: 0 0.75rem; color: #23527c;} header nav li::after { content: "/";color: #a0a0a0;} header nav li:last-child::after {content: "";} header nav li:last-child a {margin-right:0;} header nav li:first-child a {margin-left:0;} a{color:#23527c; text-decoration:none} a:hover{border-bottom: 1px solid #23527c;} li{line-height:1.8} pre.highlight {margin-bottom: 1rem;padding: 0.5rem 0.75rem;border-radius: .15rem;background-color: #444; color: #f0f0f0} pre {display: block;margin: 0 0 1rem;font-size: .875rem;line-height: 1.4;overflow: auto;} footer{margin: 0 0 4rem;} .cta-section {margin: 3rem 0;padding: 1rem 0;border-top: 4px dashed #ff7a7a;border-bottom: 4px dashed #ff7a7a;} .cta-section a.btn{border: 1px solid #ababab;padding: 0.5rem 1.5rem;border-radius: 0.5rem;background-color: #ffffff; transition:all 0.3s ease;} blockquote{border-left: 5px solid #e3e3e3;padding-left: 15px;margin-left: 10px;} /* Custom end */ </style> </head> <body itemscope itemtype="http://schema.org/WebPage"> <div class="container"> <!--[if lte IE 9]> <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p> <![endif]--> <header class="clearfix"> <h2><a href="https://sarathlal.com">Sarathlal N</a></h2> <nav> <ul> <li><a href="https://sarathlal.com/about/">About Me</a></li> <li><a href="https://sarathlal.com/archive/">Archive</a></li> </ul> </nav> </header> <article class="post" itemscope itemtype="http://schema.org/CreativeWork"> <h1 class="entry-title" itemprop="headline">Unit testing WordPress plugin using PHPUnit</h1> <h3 id="prerequisite">Prerequisite</h3> <p>Here is my system stack &amp; supporting tools with version number.</p> <ol> <li>LAMP stack (Linux Mint 20.2, Apache 2.4.41, MySql 15.1, PHP 7.4.3)</li> <li>WordPress (5.9)</li> <li>WP-CLI (2.5.0)</li> <li>WordPress Plugin to be tested</li> <li>Composer (2.2.5)</li> <li>SVN (1.13.0)</li> <li>Git (2.25.1)</li> <li>Wget (1.20.3)</li> </ol> <p>Before starting unit test in WordPress with PHPUnit, it is better to familiarize all this tools and confirm that it is working in our system.</p> <h2 id="plugin-code">Plugin code</h2> <p>Here is the sample plugin code that copied from <a href="https://www.smashingmagazine.com/2017/12/automated-testing-wordpress-plugins-phpunit/" target="_blank">Smashing Magazine</a>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php 

class WP_Meta_Verify 
{
    public function __construct()
    {
        add_action('wp_head', array($this, 'header_code'));
    }

    public function header_code()
    {
        $google_code = get_option('wpmv_google_code');
        $bing_code = get_option('wpmv_google_code');

        echo $this-&gt;google_site_verification($google_code);
        echo $this-&gt;bing_site_verification($bing_code);
    }

    public function google_site_verification($code)
    {
        return "&lt;meta name=\"google-site-verification\" content=\"$code\"&gt;";
    }

    public function bing_site_verification($code)
    {
        return "&lt;meta name=\"msvalidate.01\" content=\"$code\"&gt;";
    } 
} 

new WP_Meta_Verify();
</code></pre></div></div> <p>This is a simple plugin that displays Google and Bing webmaster verification meta tags in the header of WordPress’ front end. In the plugin code, removed settings page related code to make our code simple.</p> <h3 id="step-1">Step 1</h3> <p>Go to the tested plugin directory in our WordPress installation.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /var/www/html/your-wordpress/wp-content/plugins/sample-plugin/
</code></pre></div></div> <h3 id="step-2">Step 2</h3> <p>Now we need to include PHPUnit as development dependancy.</p> <p>Create <code class="language-plaintext highlighter-rouge">composer.json</code> for the project if it is not exist.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer init
</code></pre></div></div> <p><strong>Add PHPUnit</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require --dev phpunit/phpunit
</code></pre></div></div> <h3 id="step-3">Step 3</h3> <p>Generate the plugin test files.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wp scaffold plugin-tests plugin-directory-name
</code></pre></div></div> <h5 id="example">Example</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wp scaffold plugin-tests sample-plugin
</code></pre></div></div> <p>This command will generate all the files needed for running tests.</p> <h3 id="step-4">Step 4</h3> <p>Initialize the testing environment locally.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash bin/install-wp-tests.sh test_database_name mysql_user_name 'mysql_user_password' database_host_name wp_version
</code></pre></div></div> <h5 id="example-1">Example</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash bin/install-wp-tests.sh wp_test root 'znode123' localhost latest
</code></pre></div></div> <h3 id="step-5">Step 5</h3> <p>Run the default test in <code class="language-plaintext highlighter-rouge">tests/test-sample.php</code> using PHPUnit command. Now we have included PHPUnit as library in our project. So we have to use relative path to run the test.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit
</code></pre></div></div> <h4 id="issue-1">Issue 1</h4> <p>When I run plugin test, first I got the below error message in the terminal.</p> <blockquote> <p>Error: The PHPUnit Polyfills library is a requirement for running the WP test suite.</p> <p>If you are trying to run plugin/theme integration tests, make sure the PHPUnit Polyfills library (https://github.com/Yoast/PHPUnit-Polyfills) is available and either load the autoload file of this library in your own test bootstrap before calling the WP Core test bootstrap file; or set the absolute path to the PHPUnit Polyfills library in a “WP_TESTS_PHPUNIT_POLYFILLS_PATH” constant to allow the WP Core bootstrap to load the Polyfills.</p> <p>If you are trying to run the WP Core tests, make sure to set the “WP_RUN_CORE_TESTS” constant to 1 and run <code class="language-plaintext highlighter-rouge">composer update -W</code> before running the tests. Once the dependencies are installed, you can run the tests using the Composer-installed version of PHPUnit or using a PHPUnit phar file, but the dependencies do need to be installed whichever way the tests are run.”</p> </blockquote> <p><strong>Fix</strong></p> <p>PHPUnit Polyfills library is now required by WordPress tests to fix the version compatibility issues we often face with WordPress. So now we need to add a PHPUnit Polyfills library in the plugin as a development dependancy using Composer.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require --dev yoast/phpunit-polyfills
</code></pre></div></div> <p>Once the PHPUnit Polyfills library is available, include it in the first line of <code class="language-plaintext highlighter-rouge">sample-plugin/tests/bootstrap.php</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require dirname( dirname( __FILE__ ) ) . '/vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php';
</code></pre></div></div> <h3 id="step-6">Step 6</h3> <p>Now it is the time to create actual test for our plugin. It is better to delete <code class="language-plaintext highlighter-rouge">tests/test-sample.php</code> file.</p> <p>Create a <code class="language-plaintext highlighter-rouge">test-wp-meta-verify.php</code> file in the tests folder.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php 

class WP_Meta_VerifyTest extends WP_UnitTestCase
{
    public function set_up()
    {
        parent::set_up();
        $this-&gt;class_instance = new WP_Meta_Verify();
    }

    public function test_google_site_verification()
    {
        $meta_tag = $this-&gt;class_instance-&gt;google_site_verification('B6wFaCRbzWE42SyxSvKUOyyPxZfJCb5g');
        $expected = '&lt;meta name="google-site-verification" content="B6wFaCRbzWE42SyxSvKUOyyPxZfJCb5g"&gt;';

        $this-&gt;assertEquals($expected, $meta_tag);
    }

    public function test_bing_site_verification()
    {
        $meta_tag = $this-&gt;class_instance-&gt;bing_site_verification('B6wFaCRbzWE42SyxSvKUOyyPxZfJCb5g');
        $expected = '&lt;meta name="msvalidate.01" content="B6wFaCRbzWE42SyxSvKUOyyPxZfJCb5g"&gt;';

        $this-&gt;assertEquals($expected, $meta_tag);
    }s
}
</code></pre></div></div> <p>Now again run the tests &amp; we can see the result.</p> <p>We can refer the guidelines from PHPUnit to make good test cases &amp; structure.</p> <ol> <li><a href="https://phpunit.readthedocs.io/en/9.5/writing-tests-for-phpunit.html" target="_blank">Writing Tests for PHPUnit</a></li> <li><a href="https://phpunit.readthedocs.io/en/9.5/organizing-tests.html" target="_blank">Organizing Tests</a></li> </ol> <p>There is too many blog post and tutorials about unit testing &amp; how to write best tast cases. A google search is enough to find good articles.</p> <h3>Recent Posts</h3> <ol> <li><a href="https://sarathlal.com/git-workflow-bitbucket-jira/"> Streamlining Development - Our Journey with Git, Bitbucket, and Jira</a></li> <li><a href="https://sarathlal.com/optimizing-woocommerce-slow-admin-side-payment-gateway-plugin/"> The Amazing Adventure - Solving the Mysteries of a WooCommerce Store</a></li> <li><a href="https://sarathlal.com/installing-docker-compose-linux-mint-20/"> Installing Docker Compose in Linux Mint 20</a></li> <li><a href="https://sarathlal.com/postgresql-database-with-django/"> Using PostgreSQL database with Django</a></li> <li><a href="https://sarathlal.com/find-largest-number-in-list-python/"> Find largest number in a list of numbers - Python</a></li> </ol> <p class="entry-meta"> <span class="entry-time text-muted">This article was published on <time class="entry-time" itemprop="datePublished" datetime="2022-04-07T00:00:00+05:30">April 7, 2022</time></span> </p> <hr> <h3>Your Questions / Comments</h3> <p class="after-post">If you found this article interesting, found errors, or just want to discuss about it, please <a href="/about/">get in touch</a>.</p> </article> <!-- Footer --> <footer> </footer> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-46959192-1', 'auto'); ga('send', 'pageview'); </script> </div> </body> </html>
